<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Gerenciamento de Visitas</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-in { animation: slideIn 0.5s ease-out; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzORd3kgNiCu1WoRaccr91wMue3rjBNIjAHE99m1IQ4XRV6WKSsptylS2DQeoCVkd3qYw/exec';

        // √çcones
        const DollarSign = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        );

        const CheckCircle = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );

        const AlertCircle = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const Clock = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        const User = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const Building2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 21h18M9 8h1M9 12h1M9 16h1M14 8h1M14 12h1M14 16h1M6 3h12v18H6z"></path>
            </svg>
        );

        const RefreshCw = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        const Settings = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m5.2-15.8l-4.2 4.2M7 12l-4.2 4.2M23 12h-6m-6 0H5m15.8 5.2l-4.2-4.2M7 7L2.8 2.8"></path>
            </svg>
        );

        const Save = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
        );

        const Plus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        );

        function AdminPanel() {
            const [visitors, setVisitors] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('todos');
            const [processing, setProcessing] = useState({});
            const [showConfig, setShowConfig] = useState(false);
            const [regras, setRegras] = useState([]);
            const [savingRules, setSavingRules] = useState(false);

            useEffect(() => {
                loadVisitors();
                loadRegras();
            }, []);

            const loadVisitors = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=admin`);
                    const data = await response.json();
                    setVisitors(Array.isArray(data) ? data : []);
                } catch (error) {
                    console.error('Erro ao carregar visitantes:', error);
                    alert('Erro ao carregar dados. Verifique a conex√£o.');
                } finally {
                    setLoading(false);
                }
            };

            const loadRegras = async () => {
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=obter_regras`);
                    const data = await response.json();
                    if (data.status === 'SUCCESS') {
                        setRegras(data.regras);
                    }
                } catch (error) {
                    console.error('Erro ao carregar regras:', error);
                }
            };

            const handleSaveRegras = async () => {
                setSavingRules(true);
                try {
                    // üîß CORRE√á√ÉO: Usar FormData em vez de URLSearchParams
                    const formData = new FormData();
                    formData.append('action', 'salvar_regras');
                    formData.append('regras', JSON.stringify(regras));

                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'SUCCESS') {
                        alert('‚úÖ Regras salvas com sucesso!');
                        setShowConfig(false);
                        loadRegras(); // Recarrega as regras para confirmar
                    } else {
                        alert('‚ùå Erro ao salvar regras: ' + (result.message || 'Erro desconhecido'));
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao salvar regras: ' + error.message);
                } finally {
                    setSavingRules(false);
                }
            };

            const handleMarcarPago = async (visitor) => {
                if (!confirm(`Confirmar pagamento de R$ ${visitor.valor.toFixed(2).replace('.', ',')} de ${visitor.nome}?`)) {
                    return;
                }

                setProcessing(prev => ({ ...prev, [visitor.row]: true }));

                try {
                    const formData = new FormData();
                    formData.append('action', 'marcar_pago');
                    formData.append('row', visitor.row);

                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.status === 'SUCCESS') {
                        alert('‚úÖ Pagamento registrado com sucesso!');
                        loadVisitors();
                    } else {
                        alert('‚ùå Erro ao registrar pagamento.');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao processar pagamento.');
                } finally {
                    setProcessing(prev => ({ ...prev, [visitor.row]: false }));
                }
            };

            const filteredVisitors = visitors.filter(v => {
                if (filter === 'ativos') return v.status === 'Check-in Realizado';
                if (filter === 'finalizados') return v.status === 'Check-out Realizado';
                if (filter === 'pendentes') return v.status === 'Check-out Realizado' && !v.pago && v.valor > 0;
                if (filter === 'pagos') return v.pago;
                return true;
            });

            const stats = {
                total: visitors.length,
                ativos: visitors.filter(v => v.status === 'Check-in Realizado').length,
                finalizados: visitors.filter(v => v.status === 'Check-out Realizado').length,
                pendentes: visitors.filter(v => v.status === 'Check-out Realizado' && !v.pago && v.valor > 0).length,
                pagos: visitors.filter(v => v.pago).length,
                valorPendente: visitors.filter(v => !v.pago && v.valor > 0).reduce((sum, v) => sum + v.valor, 0),
                valorRecebido: visitors.filter(v => v.pago).reduce((sum, v) => sum + v.valor, 0)
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="glass-effect rounded-2xl shadow-2xl p-6 mb-6 animate-slide-in">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800 mb-2">Painel Administrativo</h1>
                                    <p className="text-gray-600">Gerenciamento de Visitas e Pagamentos</p>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowConfig(!showConfig)}
                                        className="flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition"
                                    >
                                        <Settings size={20} />
                                        Configurar Pre√ßos
                                    </button>
                                    <button
                                        onClick={loadVisitors}
                                        disabled={loading}
                                        className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition"
                                    >
                                        <RefreshCw size={20} className={loading ? 'animate-spin' : ''} />
                                        Atualizar
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Modal de Configura√ß√£o */}
                        {showConfig && (
                            <div className="glass-effect rounded-2xl shadow-2xl p-6 mb-6 animate-fade-in">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <Settings size={24} />
                                    Configura√ß√£o de Regras de Pagamento
                                </h2>
                                <p className="text-gray-600 mb-6">
                                    Configure os valores de cobran√ßa de acordo com o tempo de perman√™ncia. As regras s√£o aplicadas automaticamente no check-out.
                                </p>

                                <div className="space-y-3 mb-6">
                                    {regras.map((regra, index) => (
                                        <div key={index} className="flex items-center gap-4 bg-white p-4 rounded-lg">
                                            <div className="flex-1">
                                                <label className="text-sm font-medium text-gray-700 block mb-1">At√© (horas)</label>
                                                <input
                                                    type="number"
                                                    step="0.5"
                                                    value={regra.ateHoras}
                                                    onChange={(e) => {
                                                        const novasRegras = [...regras];
                                                        novasRegras[index].ateHoras = parseFloat(e.target.value);
                                                        setRegras(novasRegras);
                                                    }}
                                                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                                                />
                                            </div>
                                            <div className="flex-1">
                                                <label className="text-sm font-medium text-gray-700 block mb-1">Valor Base (R$)</label>
                                                <input
                                                    type="number"
                                                    step="10"
                                                    value={regra.valorBase}
                                                    onChange={(e) => {
                                                        const novasRegras = [...regras];
                                                        novasRegras[index].valorBase = parseFloat(e.target.value);
                                                        setRegras(novasRegras);
                                                    }}
                                                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                                                />
                                            </div>
                                            <div className="flex-1">
                                                <label className="text-sm font-medium text-gray-700 block mb-1">Adicional/hora (R$)</label>
                                                <input
                                                    type="number"
                                                    step="10"
                                                    value={regra.valorAdicional}
                                                    onChange={(e) => {
                                                        const novasRegras = [...regras];
                                                        novasRegras[index].valorAdicional = parseFloat(e.target.value);
                                                        setRegras(novasRegras);
                                                    }}
                                                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                                                />
                                            </div>
                                            <button
                                                onClick={() => {
                                                    const novasRegras = regras.filter((_, i) => i !== index);
                                                    setRegras(novasRegras);
                                                }}
                                                className="mt-6 p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition"
                                            >
                                                <Trash2 size={20} />
                                            </button>
                                        </div>
                                    ))}
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setRegras([...regras, { ateHoras: 0, valorBase: 0, valorAdicional: 0 }]);
                                        }}
                                        className="flex items-center gap-2 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition"
                                    >
                                        <Plus size={20} />
                                        Adicionar Regra
                                    </button>
                                    <button
                                        onClick={handleSaveRegras}
                                        disabled={savingRules}
                                        className="flex items-center gap-2 px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition disabled:opacity-50"
                                    >
                                        {savingRules ? (
                                            <RefreshCw size={20} className="animate-spin" />
                                        ) : (
                                            <Save size={20} />
                                        )}
                                        Salvar Configura√ß√µes
                                    </button>
                                    <button
                                        onClick={() => setShowConfig(false)}
                                        className="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Cards de Estat√≠sticas */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div className="glass-effect rounded-xl p-5 shadow-lg animate-fade-in">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600 mb-1">Visitantes Ativos</p>
                                        <p className="text-3xl font-bold text-blue-600">{stats.ativos}</p>
                                    </div>
                                    <Clock size={40} className="text-blue-500 opacity-50" />
                                </div>
                            </div>

                            <div className="glass-effect rounded-xl p-5 shadow-lg animate-fade-in">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600 mb-1">Check-outs Realizados</p>
                                        <p className="text-3xl font-bold text-green-600">{stats.finalizados}</p>
                                    </div>
                                    <CheckCircle size={40} className="text-green-500 opacity-50" />
                                </div>
                            </div>

                            <div className="glass-effect rounded-xl p-5 shadow-lg animate-fade-in">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600 mb-1">Pagamentos Pendentes</p>
                                        <p className="text-3xl font-bold text-amber-600">{stats.pendentes}</p>
                                        <p className="text-xs text-gray-500 mt-1">R$ {stats.valorPendente.toFixed(2).replace('.', ',')}</p>
                                    </div>
                                    <AlertCircle size={40} className="text-amber-500 opacity-50" />
                                </div>
                            </div>

                            <div className="glass-effect rounded-xl p-5 shadow-lg animate-fade-in">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-sm text-gray-600 mb-1">Total Recebido</p>
                                        <p className="text-3xl font-bold text-emerald-600">R$ {stats.valorRecebido.toFixed(2).replace('.', ',')}</p>
                                        <p className="text-xs text-gray-500 mt-1">{stats.pagos} pagamentos</p>
                                    </div>
                                    <DollarSign size={40} className="text-emerald-500 opacity-50" />
                                </div>
                            </div>
                        </div>

                        {/* Filtros */}
                        <div className="glass-effect rounded-xl p-4 mb-6 shadow-lg">
                            <div className="flex flex-wrap gap-2">
                                {[
                                    { id: 'todos', label: `Todos (${stats.total})` },
                                    { id: 'ativos', label: `Ativos (${stats.ativos})` },
                                    { id: 'finalizados', label: `Finalizados (${stats.finalizados})` },
                                    { id: 'pendentes', label: `Pendentes (${stats.pendentes})` },
                                    { id: 'pagos', label: `Pagos (${stats.pagos})` }
                                ].map(({ id, label }) => (
                                    <button
                                        key={id}
                                        onClick={() => setFilter(id)}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            filter === id
                                                ? 'bg-blue-600 text-white shadow-lg'
                                                : 'bg-white text-gray-700 hover:bg-gray-100'
                                        }`}
                                    >
                                        {label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Lista de Visitantes */}
                        <div className="glass-effect rounded-xl shadow-lg p-6">
                            {loading ? (
                                <div className="text-center py-12">
                                    <RefreshCw size={48} className="animate-spin mx-auto text-blue-600 mb-4" />
                                    <p className="text-gray-600">Carregando dados...</p>
                                </div>
                            ) : filteredVisitors.length === 0 ? (
                                <div className="text-center py-12">
                                    <AlertCircle size={48} className="mx-auto text-gray-400 mb-4" />
                                    <p className="text-gray-600">Nenhum visitante encontrado neste filtro.</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {filteredVisitors.map(visitor => (
                                        <div
                                            key={visitor.row}
                                            className={`border-2 rounded-xl p-5 transition ${
                                                visitor.status === 'Check-in Realizado'
                                                    ? 'border-blue-300 bg-blue-50'
                                                    : visitor.pago
                                                    ? 'border-green-300 bg-green-50'
                                                    : visitor.valor > 0
                                                    ? 'border-amber-300 bg-amber-50'
                                                    : 'border-gray-300 bg-white'
                                            }`}
                                        >
                                            <div className="flex items-start justify-between">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <User size={24} className="text-gray-600" />
                                                        <h3 className="text-xl font-bold text-gray-800">{visitor.nome}</h3>
                                                        {visitor.status === 'Check-in Realizado' && (
                                                            <span className="px-3 py-1 bg-blue-600 text-white text-xs font-bold rounded-full">
                                                                ATIVO
                                                            </span>
                                                        )}
                                                        {visitor.pago && (
                                                            <span className="px-3 py-1 bg-green-600 text-white text-xs font-bold rounded-full flex items-center gap-1">
                                                                <CheckCircle size={14} /> PAGO
                                                            </span>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-700 ml-9">
                                                        <div className="flex items-center gap-2">
                                                            <Building2 size={16} />
                                                            <span><strong>Empresa:</strong> {visitor.empresa}</span>
                                                        </div>
                                                        <div><strong>Respons√°vel:</strong> {visitor.responsavel}</div>
                                                        <div><strong>Setor:</strong> {visitor.setor}</div>
                                                        <div><strong>Check-in:</strong> {visitor.dataHora}</div>
                                                        {visitor.checkout && (
                                                            <div><strong>Check-out:</strong> {visitor.checkout}</div>
                                                        )}
                                                        {visitor.email && (
                                                            <div><strong>Email:</strong> {visitor.email}</div>
                                                        )}
                                                    </div>
                                                </div>

                                                {visitor.status === 'Check-out Realizado' && visitor.valor > 0 && (
                                                    <div className="ml-4 text-right">
                                                        <p className="text-2xl font-bold text-gray-800 mb-2">
                                                            R$ {visitor.valor.toFixed(2).replace('.', ',')}
                                                        </p>
                                                        {!visitor.pago ? (
                                                            <button
                                                                onClick={() => handleMarcarPago(visitor)}
                                                                disabled={processing[visitor.row]}
                                                                className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition flex items-center gap-2 disabled:opacity-50"
                                                            >
                                                                {processing[visitor.row] ? (
                                                                    <>
                                                                        <RefreshCw size={18} className="animate-spin" />
                                                                        Processando...
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <DollarSign size={18} />
                                                                        Marcar como Pago
                                                                    </>
                                                                )}
                                                            </button>
                                                        ) : (
                                                            <div className="flex items-center gap-2 text-green-600 font-medium">
                                                                <CheckCircle size={20} />
                                                                Pagamento Confirmado
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminPanel />);
    </script>